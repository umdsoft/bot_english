<div>
  <label class="block text-sm text-gray-600 mb-1">Tavsif (ixtiyoriy)</label>

  <!-- mini-toolbar -->
  <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
    <span class="mr-2">Formatlash:</span>
    <button type="button" data-ins="bold"   class="px-2 py-0.5 rounded border">B</button>
    <button type="button" data-ins="italic" class="px-2 py-0.5 rounded border italic">I</button>
    <button type="button" data-ins="underline" class="px-2 py-0.5 rounded border">U</button>
    <button type="button" data-ins="strike" class="px-2 py-0.5 rounded border line-through">S</button>
    <button type="button" data-ins="link"   class="px-2 py-0.5 rounded border">Link</button>
    <button type="button" data-ins="br"     class="px-2 py-0.5 rounded border">â†µ</button>
    <span class="ml-auto text-xs text-gray-500">
      Qoâ€™llab-quvvatlanadi: <code>&lt;b&gt; &lt;i&gt; &lt;u&gt; &lt;s&gt; &lt;a&gt; &lt;br&gt;</code>
    </span>
  </div>

  <textarea id="desc" name="description"
            class="w-full rounded border px-3 py-2 font-[system-ui] leading-6"
            rows="6"
            placeholder="Masalan:
<b>ðŸ”¥ Eâ€™lon!</b><br>
Bugun soat 18:00 da yigâ€˜ilish boâ€˜ladi.<br><br>
<i>Manzil:</i> Chilonzor...">
  </textarea>

  <!-- Telegramga oâ€˜xshash jonli koâ€˜rish -->
  <div class="mt-3">
    <div class="text-sm text-gray-500 mb-1">Telegramda qanday koâ€˜rinadi (preview):</div>
    <div id="tgPreview" class="rounded-xl border p-3 bg-white text-[15px] leading-6"></div>
  </div>
</div>

<script>
  // --- kichik yordamchilar ---
  const ta = document.getElementById('desc');
  const prev = document.getElementById('tgPreview');

  // HTML whitelist (Telegram parse_mode=HTML uchun xavfsiz taglar)
  const SAFE_TAGS = ['B','I','U','S','A','BR'];
  function sanitizeHtml(html) {
    const tpl = document.createElement('template');
    tpl.innerHTML = html;
    (function walk(n){
      for (const el of [...n.childNodes]) {
        if (el.nodeType === 1) {
          if (!SAFE_TAGS.includes(el.tagName)) {
            const span = document.createElement('span');
            span.textContent = el.textContent;
            el.replaceWith(span);
          } else {
            if (el.tagName === 'A') {
              // faqat href qoldiramiz
              const href = el.getAttribute('href') || '#';
              el.setAttribute('href', href);
              // rel/target qoâ€˜shamiz
              el.setAttribute('rel','noopener noreferrer');
              el.setAttribute('target','_blank');
            }
            walk(el);
          }
        }
      }
    })(tpl.content);
    return tpl.innerHTML;
  }

  function updatePreview() {
    // Ta textarea ichiga HTML yoziladi (bold, italik, <br>, link va hok.)
    const clean = sanitizeHtml(ta.value);
    prev.innerHTML = clean || '<span class="text-gray-400">Boâ€˜shâ€¦</span>';
  }
  ta.addEventListener('input', updatePreview);
  updatePreview();

  // Toolbar tugmalari
  document.querySelectorAll('[data-ins]').forEach(btn=>{
    btn.addEventListener('click', () => {
      const cmd = btn.dataset.ins;
      const start = ta.selectionStart, end = ta.selectionEnd;
      let v = ta.value;

      const wrap = (before, after='')=>{
        ta.value = v.slice(0,start) + before + v.slice(start,end) + after + v.slice(end);
        ta.focus();
        ta.selectionStart = start + before.length;
        ta.selectionEnd   = end   + before.length;
        updatePreview();
      };

      if (cmd === 'bold')       wrap('<b>','</b>');
      else if (cmd === 'italic')    wrap('<i>','</i>');
      else if (cmd === 'underline') wrap('<u>','</u>');
      else if (cmd === 'strike')    wrap('<s>','</s>');
      else if (cmd === 'br')        wrap('<br>');
      else if (cmd === 'link') {
        const url = prompt('Havola URL (https://...)', 'https://');
        if (!url) return;
        ta.value = v.slice(0,start) + `<a href="${url}">` + (v.slice(start,end) || 'link') + `</a>` + v.slice(end);
        ta.focus();
        updatePreview();
      }
    });
  });
</script>
